#version: "3.9" # docker version --> 버전2이상 부터는 굳이 명시 안해줘도 된다고 함. 

services:
  nginx:
    container_name: nginx
    build: ./nginx
    ports:
      - "8084:80"
    volumes: # 필요한 파일 내파일:도커파일
      - ./nginx/nginx.conf:/etc/nginx.conf.d
      #- ./django/app:/app
      #- ./django/venti/static:/static
    depends_on:
      - django_app
    networks:
      - app-tier

  mysql:
    build: ./mysql
    ports:
      - "3306:3306"
    networks:
      - app-tier  

  django_app: # nginx proxy name
    container_name: django_app
    build:
      context: .
      dockerfile: ./django/Dockerfile
    command: 
      bash -c "
      chmod +x ./wait-for-it.sh &&
      ./wait-for-it.sh mysql:3306 -t 10 &&
      python3 manage.py makemigrations &&
      python3 manage.py migrate &&
      gunicorn admin.wsgi:application --bind 0.0.0.0:8000"
    ports:
      - "8000:8000"
    expose:
      - "8000"
    depends_on:
      - mysql
    links:
      - mysql:mysql
    restart: always # 변경사항 있을 때마다 리스타트
    volumes:
      - ./django:/app
    networks:
      - app-tier

networks:
  app-tier:
    driver: bridge

